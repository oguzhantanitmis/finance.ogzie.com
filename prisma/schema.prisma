generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String?
  riskScore     Int       @default(100)
  netWorth      Float     @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  assets        Asset[]
  debts         Debt[]
  transactions  Transaction[]
  subscriptions Subscription[]
  snapshots     Snapshot[]
  creditCards   CreditCard[]
  insights      AIInsight[]
}

enum AssetType {
  CASH
  BANK
  GOLD
  FX
  CRYPTO
  STOCK
  ESTATE
  OTHER
  RECEIVABLE
}

model Asset {
  id            String    @id @default(cuid())
  userId        String?   // Optional for migration compatibility, should be required later
  name          String
  type          AssetType
  amount        Float
  unitPrice     Float?    // Maliyet
  currency      String    @default("TRY")
  lastValue     Float?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  user          User?     @relation(fields: [userId], references: [id])
}

enum DebtType {
  CREDIT_CARD
  LOAN
  KMH
  PERSONAL
  MANUAL // Legacy support
}

model Debt {
  id                String    @id @default(cuid())
  userId            String?   // Optional for migration
  name              String
  type              DebtType
  
  // Kredi Kartƒ± & KMH
  limit             Float?
  cutOffDay         Int?      // Hesap kesim (1-31)
  paymentDueDay     Int?      // Son √∂deme g√ºn√º (1-31)
  
  // Kredi
  totalPrincipal    Float?    // √áekilen tutar
  installments      Int?
  remainingInstallments Int?
  
  // G√ºncel Durum
  totalBalance      Float     // Kart i√ßin d√∂nem borcu, Kredi i√ßin kalan anapara
  remainingBalance  Float     // √ñdenmesi gereken (Aktif bor√ß)
  interestRate      Float     @default(0)
  minPaymentRate    Float     @default(0.20) // 0.20 or 0.40
  
  // Vergi Oranlarƒ± (Sabit ama deƒüi≈ütirilebilir)
  kkdfRate          Float     @default(0.15)
  bsmvRate          Float     @default(0.15)

  dueDate           DateTime? // Tek seferlik bor√ßlar i√ßin
  lastPaymentDate   DateTime?
  isPaid            Boolean   @default(false)

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  user              User?     @relation(fields: [userId], references: [id])
  paymentPlan       PaymentPlan[]
}

model PaymentPlan {
  id            String    @id @default(cuid())
  debtId        String
  installmentNo Int
  amount        Float     // Taksit tutarƒ±
  principalAmount Float   // Ana para kƒ±smƒ±
  interestAmount  Float   // Faiz kƒ±smƒ±
  taxAmount       Float   // Vergi kƒ±smƒ±
  dueDate       DateTime
  isPaid        Boolean   @default(false)
  paidDate      DateTime?
  
  debt          Debt      @relation(fields: [debtId], references: [id], onDelete: Cascade)
}

model Transaction {
  id          String    @id @default(cuid())
  userId      String?
  amount      Float
  type        String    // INCOME, EXPENSE
  category    String
  description String?
  date        DateTime  @default(now())
  
  assetId     String?
  debtId      String?
  
  user        User?     @relation(fields: [userId], references: [id])
}

model Subscription {
  id            String    @id @default(cuid())
  userId        String?
  name          String
  amount        Float
  currency      String    @default("TRY")
  billingCycle  String    // MONTHLY, YEARLY
  category      String    @default("Genel")
  nextPayment   DateTime
  isActive      Boolean   @default(true)
  
  user          User?     @relation(fields: [userId], references: [id])
}

model AIInsight {
  id          String   @id @default(cuid())
  userId      String?
  title       String
  content     String   @db.Text
  type        String   @default("INFO") // INFO, WARNING, SUCCESS, RISK
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  user        User?    @relation(fields: [userId], references: [id])
}


model FinanceJournal {
  id        String    @id @default(cuid())
  content   String    @db.Text
  date      DateTime  @default(now())
  isParsed  Boolean   @default(false)
}

model Reminder {
  id          String    @id @default(cuid())
  title       String
  description String?
  dueDate     DateTime
  isCompleted Boolean   @default(false)
  priority    String    @default("NORMAL")
}

model Snapshot {
  id        String   @id @default(cuid())
  userId    String
  date      DateTime @default(now())
  netWorth  Float
  totalAssets Float
  totalDebts  Float
  assets    Json     // Detailed breakdown
  debts     Json     // Detailed breakdown
  
  user      User     @relation(fields: [userId], references: [id])
}

// ============================================================
// üè¶ BANKA SEVƒ∞YESƒ∞ KREDƒ∞ KARTI Sƒ∞STEMƒ∞
// ============================================================

enum CardNetwork {
  VISA
  MASTERCARD
  TROY
}

enum CardStatus {
  ACTIVE
  FROZEN
  CLOSED
}

enum TransactionType {
  PURCHASE
  INSTALLMENT_PURCHASE
  CASH_ADVANCE
  FEE
  REFUND
  ADJUSTMENT
  INTEREST_CHARGE
  TAX_CHARGE
}

enum StatementStatus {
  OPEN
  PAID
  CLOSED
  OVERDUE
}

enum InterestType {
  CONTRACTUAL
  DEFAULT_INTEREST
  CASH_ADVANCE_INTEREST
}

model CreditCard {
  id                  String    @id @default(cuid())
  userId              String
  
  // Kart Kimliƒüi
  cardName            String    // "Akbank Axess Platinum"
  bankName            String    // "Akbank"
  last4Digits         String    // "4532"
  cardNetwork         CardNetwork @default(VISA)
  status              CardStatus  @default(ACTIVE)
  color               String    @default("#6366F1")
  
  // Limitler
  totalLimit          Float     // 50.000
  cashAdvanceLimit    Float     @default(0)
  
  // Faturalama D√∂ng√ºs√º
  cutOffDay           Int       // Hesap kesim g√ºn√º (1-31)
  paymentDueDay       Int       // Son √∂deme g√ºn√º (1-31)
  
  // Faiz Oranlarƒ± (Aylƒ±k %)
  contractualRate     Float     @default(4.42)  // Akdi faiz
  defaultRate         Float     @default(5.42)  // Gecikme faizi
  cashAdvanceRate     Float     @default(5.92)  // Nakit avans faizi
  
  // Vergi Oranlarƒ±
  kkdfRate            Float     @default(0.15)
  bsmvRate            Float     @default(0.15)
  
  // Asgari √ñdeme Oranƒ±
  minPaymentRate      Float     @default(0.20)  // limit<=50k: 0.20, >50k: 0.40
  
  // Puan / √ñd√ºl
  rewardsPoints       Float     @default(0)
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  
  user                User      @relation(fields: [userId], references: [id])
  statements          CardStatement[]
  transactions        CardTransaction[]
  payments            CardPayment[]
  interestAccruals    InterestAccrual[]
}

model CardStatement {
  id                  String    @id @default(cuid())
  creditCardId        String
  
  // D√∂nem Bilgileri
  statementDate       DateTime  // Hesap kesim tarihi
  dueDate             DateTime  // Son √∂deme tarihi
  periodStart         DateTime  // D√∂nem ba≈ülangƒ±cƒ±
  periodEnd           DateTime  // D√∂nem sonu (= statementDate)
  
  // Tutarlar
  previousBalance     Float     @default(0) // √ñnceki devreden bor√ß
  newCharges          Float     @default(0) // Bu d√∂nem harcamalar
  interestCharged     Float     @default(0) // Bu d√∂neme yansƒ±tƒ±lan faiz
  taxCharged          Float     @default(0) // KKDF + BSMV
  paymentsReceived    Float     @default(0) // Bu d√∂nem gelen √∂demeler
  statementBalance    Float     @default(0) // D√∂nem sonu bor√ß
  minimumPayment      Float     @default(0) // Asgari √∂deme
  
  // Durum
  status              StatementStatus @default(OPEN)
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  creditCard          CreditCard     @relation(fields: [creditCardId], references: [id], onDelete: Cascade)
  transactions        CardTransaction[]
  payments            CardPayment[]
  interestAccruals    InterestAccrual[]
  installments        CardInstallment[]
}

model CardTransaction {
  id                  String    @id @default(cuid())
  creditCardId        String
  statementId         String?   // null = hen√ºz ekstreye girmemi≈ü
  
  // ƒ∞≈ülem Bilgileri
  type                TransactionType
  description         String
  merchant            String?   // Harcama yapƒ±lan yer
  amount              Float     // ƒ∞≈ülem tutarƒ±
  remainingAmount     Float     // Kalan tutar (taksitlerde d√º≈üer)
  transactionDate     DateTime  @default(now())
  
  // Taksit Bilgisi
  totalInstallments   Int       @default(1) // 1 = tek √ßekim
  currentInstallment  Int       @default(1) // ≈ûu anki taksit no
  
  // Nakit Avans
  isCashAdvance       Boolean   @default(false)
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  creditCard          CreditCard      @relation(fields: [creditCardId], references: [id], onDelete: Cascade)
  statement           CardStatement?  @relation(fields: [statementId], references: [id])
  installments        CardInstallment[]
}

model CardInstallment {
  id                  String    @id @default(cuid())
  transactionId       String
  statementId         String?   // Hangi ekstreye d√º≈üt√ºƒü√º
  
  installmentNo       Int       // Taksit numarasƒ±
  amount              Float     // Bu taksitin tutarƒ±
  dueDate             DateTime  // Vade tarihi
  isPaid              Boolean   @default(false)
  paidDate            DateTime?
  
  createdAt           DateTime  @default(now())
  
  transaction         CardTransaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  statement           CardStatement?  @relation(fields: [statementId], references: [id])
}

model CardPayment {
  id                  String    @id @default(cuid())
  creditCardId        String
  statementId         String?   // Hangi ekstreye sayƒ±ldƒ±ƒüƒ±
  
  amount              Float     // √ñdeme tutarƒ±
  paymentDate         DateTime  @default(now())
  description         String?   // "Asgari √ñdeme", "Tam √ñdeme" vb.
  
  // Daƒüƒ±tƒ±m Detayƒ± (JSON)
  allocationDetail    Json?     // { overdueInterest, overduePrincipal, currentInterest, currentPrincipal, ... }
  
  createdAt           DateTime  @default(now())
  
  creditCard          CreditCard     @relation(fields: [creditCardId], references: [id], onDelete: Cascade)
  statement           CardStatement? @relation(fields: [statementId], references: [id])
}

model InterestAccrual {
  id                  String    @id @default(cuid())
  creditCardId        String
  statementId         String?
  
  type                InterestType
  baseAmount          Float     // Faiz hesaplanan anapara
  rate                Float     // Aylƒ±k oran
  dayCount            Int       // G√ºn sayƒ±sƒ±
  interest            Float     // Hesaplanan saf faiz
  kkdf                Float     // KKDF tutarƒ±
  bsmv                Float     // BSMV tutarƒ±
  totalCost           Float     // Faiz + KKDF + BSMV
  
  calculatedAt        DateTime  @default(now())
  
  creditCard          CreditCard     @relation(fields: [creditCardId], references: [id], onDelete: Cascade)
  statement           CardStatement? @relation(fields: [statementId], references: [id])
}
